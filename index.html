<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Campeonato de Cementerio - CEIP Puente de Simancas">
    <meta name="theme-color" content="#059669">
    
    <!-- PWA Tags -->
    <link rel="manifest" href="manifest-campeonato.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Campeonato CEIP">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-campeonato-192.png">
    <link rel="apple-touch-icon" href="icon-campeonato-192.png">
    
    <title>Campeonato Cementerio - CEIP Puente de Simancas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .admin-only { display: none; }
        .is-admin .admin-only { display: block; }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        .bracket-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        input[type="number"], input[type="text"], input[type="password"] { font-size: 16px !important; }
        .active-tab { background-color: #065f46 !important; border: 1px solid #10b981 !important; opacity: 1 !important; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 1.5s ease-in-out infinite; }
        .save-indicator { position: fixed; bottom: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 12px; font-size: 12px; font-weight: bold; z-index: 1000; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .toast { position: fixed; top: 80px; right: 20px; background: white; padding: 16px 20px; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 1000; border-left: 4px solid #10b981; animation: slideIn 0.3s ease-out; }
        .match-completed { background: #f0fdf4 !important; }
        .match-pending { background: white !important; }
        .playoff-match { min-height: 80px; }
        
        /* Loading spinner */
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Install button */
        .install-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            z-index: 100;
            display: none;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-size: 12px;
        }
        .install-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }
        .install-btn.show {
            display: flex;
        }
    </style>
</head>
<body class="bg-stone-50 min-h-screen text-slate-900 overflow-x-hidden">

    <!-- INSTALL BUTTON -->
    <button id="installBtn" class="install-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
        Instalar App
    </button>

    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container"></div>

    <!-- SAVE INDICATOR -->
    <div id="save-indicator" class="save-indicator hidden">‚úì Guardado</div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-emerald-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center border-4 border-emerald-500">
            <div class="text-5xl mb-4">üè´</div>
            <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-1">CEIP Puente de Simancas</h2>
            <p class="text-emerald-600 font-bold text-xs mb-6 uppercase tracking-widest">Torneo de Cementerio</p>
            <input type="password" id="pass-input" placeholder="Clave Profesor" 
                class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-4 text-center text-xl tracking-widest focus:border-emerald-500 outline-none transition-all"
                onkeypress="if(event.key==='Enter') checkLogin()">
            <div class="flex flex-col gap-3">
                <button onclick="checkLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl transition shadow-lg active:scale-95">
                    Acceso Profesor
                </button>
                <button onclick="enterAsGuest()" class="w-full text-slate-400 font-bold py-2 text-sm hover:text-emerald-600 transition">
                    Ver como Espectador
                </button>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-emerald-700 text-white shadow-lg sticky top-0 z-50 border-b-4 border-emerald-800">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex flex-col py-3 gap-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl md:text-3xl">üéæ</span>
                        <div>
                            <h1 class="text-base md:text-lg font-black tracking-tighter uppercase italic leading-tight">Campeonato Cementerio</h1>
                            <p class="text-[9px] md:text-[10px] font-medium opacity-90">Puente de Simancas ¬∑ 2025/2026</p>
                        </div>
                    </div>
                    <div class="admin-only flex gap-2">
                        <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-800 px-3 py-2 rounded-xl text-[10px] font-bold transition" title="Exportar resultados">
                            üìä
                        </button>
                        <button onclick="showBackupModal()" class="bg-emerald-600 hover:bg-emerald-800 px-3 py-2 rounded-xl text-[10px] font-bold transition" title="Backup/Restaurar">
                            üíæ
                        </button>
                    </div>
                </div>
                <div id="nav-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-1 -mx-2 px-2 hidden">
                    <button onclick="showTab('tab-setup', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap active-tab">
                        üìã EQUIPOS
                    </button>
                    <button onclick="showTab('tab-calendar', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üóìÔ∏è PARTIDOS
                    </button>
                    <button onclick="showTab('tab-standings', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üèÜ TABLA
                    </button>
                    <button onclick="showTab('tab-playoffs', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        ‚ö° FINALES
                    </button>
                    <button onclick="showTab('tab-stats', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üìà STATS
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-6">
        
        <!-- SECCI√ìN CARGA (ADMIN) -->
        <section id="step-upload" class="space-y-6 hidden admin-only">
            <div class="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-xl border-2 border-emerald-50 text-center">
                <div class="mb-8">
                    <div class="bg-emerald-50 w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-emerald-100">
                        <span class="text-3xl md:text-4xl">üìä</span>
                    </div>
                    <h2 class="text-xl md:text-2xl font-black text-emerald-900">Configuraci√≥n Inicial</h2>
                    <p class="text-slate-500 mt-2 text-xs md:text-sm px-4">
                        Sube el Excel con <b>Nombre</b>, <b>Curso</b> y <b>G√©nero</b> (F/M/Femenino/Masculino/Chica/Chico).
                    </p>
                </div>
                
                <div id="loading-indicator" class="hidden mb-6">
                    <div class="spinner mx-auto"></div>
                    <p class="text-emerald-600 font-bold mt-3 text-sm">Procesando archivo...</p>
                </div>

                <div class="flex flex-col md:flex-row justify-center gap-3">
                    <input type="file" id="excel-input" accept=".xlsx, .xls, .csv" class="hidden" onchange="handleFile(this)">
                    <label for="excel-input" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 px-6 rounded-2xl cursor-pointer transition shadow-md active:scale-95 text-sm">
                        üìÅ Cargar Listado Excel
                    </label>
                    <button onclick="loadMockData()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-4 px-6 rounded-2xl transition border border-slate-200 text-sm">
                        üß™ Datos de Prueba
                    </button>
                </div>

                <div id="file-preview" class="mt-8 hidden border-t border-emerald-50 pt-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-emerald-50 p-3 rounded-2xl">
                            <span class="block text-xl font-black text-emerald-600" id="count-alumni">0</span>
                            <span class="text-[9px] uppercase font-bold text-emerald-800/50">Total</span>
                        </div>
                        <div class="bg-amber-50 p-3 rounded-2xl">
                            <span class="block text-xl font-black text-amber-500" id="count-captains">0</span>
                            <span class="text-[9px] uppercase font-bold text-amber-800/50">Capitanes</span>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-2xl">
                            <span class="block text-xl font-black text-blue-500" id="count-h">0</span>
                            <span class="text-[9px] uppercase font-bold text-blue-800/50">Chicos</span>
                        </div>
                        <div class="bg-pink-50 p-3 rounded-2xl">
                            <span class="block text-xl font-black text-pink-500" id="count-m">0</span>
                            <span class="text-[9px] uppercase font-bold text-pink-800/50">Chicas</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 rounded-2xl mb-8 overflow-hidden border border-slate-200">
                        <div class="p-3 bg-slate-100 text-[10px] font-black uppercase text-slate-500 text-left px-5">Alumnos detectados</div>
                        <div class="max-h-60 overflow-y-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="sticky top-0 bg-slate-100 shadow-sm">
                                    <tr class="text-[9px] uppercase text-slate-400 font-bold">
                                        <th class="p-3 pl-5">Nombre</th>
                                        <th class="p-3 text-center">Curso</th>
                                        <th class="p-3 text-center">G√©nero</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-list-body" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <button onclick="confirmParticipants()" class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-700 text-white font-black py-4 px-12 rounded-2xl shadow-xl transition transform active:scale-95 uppercase tracking-wider text-sm">
                        Confirmar y Crear Torneo
                    </button>
                </div>
            </div>
        </section>

        <!-- EMPTY STATE -->
        <section id="guest-empty" class="bg-white p-10 rounded-[2rem] text-center shadow-sm border border-slate-100 hidden">
            <div class="text-5xl mb-4 animate-pulse">‚è≥</div>
            <h2 class="text-xl font-bold text-slate-400 italic">Torneo en preparaci√≥n...</h2>
            <p class="text-slate-300 text-sm mt-2">El profesor est√° configurando los equipos</p>
        </section>

        <!-- MAIN CONTENT -->
        <div id="main-content" class="hidden">
            <!-- TAB 1: EQUIPOS -->
            <section id="tab-setup" class="tab-content active space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-lg font-black text-emerald-900 uppercase italic">üìã Equipos Inscritos</h2>
                    <button onclick="clearAllData()" class="admin-only text-red-400 text-[9px] font-black uppercase hover:text-red-600 transition">üóëÔ∏è Reiniciar Todo</button>
                </div>
                <div id="teams-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <!-- TAB 2: CALENDARIO -->
            <section id="tab-calendar" class="tab-content space-y-4">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 px-2">
                    <div>
                        <h2 class="text-lg font-black text-emerald-900 uppercase italic">üóìÔ∏è Calendario de Partidos</h2>
                        <p class="text-xs text-slate-400 mt-1">
                            <span id="matches-completed">0</span> / <span id="matches-total">0</span> completados
                        </p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <select id="team-filter" onchange="renderCalendar()" class="text-[10px] font-bold px-3 py-2 border border-emerald-100 rounded-xl bg-white">
                            <option value="">Todos los equipos</option>
                        </select>
                        <button onclick="simulateScores()" class="admin-only bg-amber-400 hover:bg-amber-500 text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase shadow-sm transition">
                            üé≤ Simular
                        </button>
                    </div>
                </div>
                <div id="calendar-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </section>

            <!-- TAB 3: TABLA -->
            <section id="tab-standings" class="tab-content space-y-4">
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-lg font-black text-emerald-900 uppercase italic">üèÜ Clasificaci√≥n General</h2>
                    <div class="text-[9px] text-slate-400 font-bold">TOP 8 ‚Üí PLAYOFFS</div>
                </div>
                <div class="bg-white rounded-3xl shadow-sm border border-emerald-50 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-[9px] uppercase font-black text-emerald-700 bg-emerald-50/50">
                                    <th class="p-3 text-center sticky left-0 bg-emerald-50/50">#</th>
                                    <th class="p-3 sticky left-8 bg-emerald-50/50">Equipo</th>
                                    <th class="p-3 text-center">PJ</th>
                                    <th class="p-3 text-center">V</th>
                                    <th class="p-3 text-center">E</th>
                                    <th class="p-3 text-center">D</th>
                                    <th class="p-3 text-center">GF</th>
                                    <th class="p-3 text-center">GC</th>
                                    <th class="p-3 text-center">DIF</th>
                                    <th class="p-3 text-center bg-emerald-100/30">PTS</th>
                                </tr>
                            </thead>
                            <tbody id="standings-body" class="divide-y divide-emerald-50"></tbody>
                        </table>
                    </div>
                </div>
                <div class="bg-emerald-50 p-4 rounded-2xl text-[10px] text-slate-600">
                    <p class="font-bold mb-2">üìå Criterios de desempate:</p>
                    <ol class="list-decimal list-inside space-y-1 ml-2">
                        <li>Mayor puntuaci√≥n</li>
                        <li>Diferencia de goles</li>
                        <li>Mayor n√∫mero de goles a favor</li>
                        <li>Enfrentamiento directo</li>
                    </ol>
                </div>
            </section>

            <!-- TAB 4: PLAYOFFS -->
            <section id="tab-playoffs" class="tab-content space-y-4">
                <div class="flex justify-between items-center px-2">
                    <div>
                        <h2 class="text-lg font-black text-emerald-900 uppercase italic">‚ö° Fase Final</h2>
                        <p class="text-xs text-slate-400 mt-1">Eliminatoria directa - Los 8 mejores equipos</p>
                    </div>
                </div>
                <div class="bg-white p-4 md:p-8 rounded-3xl shadow-sm border border-emerald-50 overflow-hidden">
                    <div class="bracket-scroll pb-6">
                        <div id="playoff-bracket" class="flex gap-6 min-w-[800px]"></div>
                    </div>
                </div>
            </section>

            <!-- TAB 5: ESTAD√çSTICAS -->
            <section id="tab-stats" class="tab-content space-y-4">
                <h2 class="text-lg font-black text-emerald-900 uppercase italic px-2">üìà Estad√≠sticas del Torneo</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 p-6 rounded-3xl shadow-lg text-white">
                        <div class="text-3xl mb-2">‚öΩ</div>
                        <div class="text-3xl font-black" id="stat-total-goals">0</div>
                        <div class="text-xs font-bold opacity-90">Goles totales</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-3xl shadow-lg text-white">
                        <div class="text-3xl mb-2">üìä</div>
                        <div class="text-3xl font-black" id="stat-avg-goals">0.0</div>
                        <div class="text-xs font-bold opacity-90">Media goles/partido</div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-amber-600 p-6 rounded-3xl shadow-lg text-white">
                        <div class="text-3xl mb-2">üéØ</div>
                        <div class="text-3xl font-black" id="stat-draws">0</div>
                        <div class="text-xs font-bold opacity-90">Empates</div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-emerald-50">
                    <h3 class="font-black text-emerald-900 mb-4 text-sm uppercase">üèÖ Top Goleadores (Equipos)</h3>
                    <div id="top-scorers" class="space-y-3"></div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-emerald-50">
                    <h3 class="font-black text-emerald-900 mb-4 text-sm uppercase">üõ°Ô∏è Mejores Defensas</h3>
                    <div id="best-defenses" class="space-y-3"></div>
                </div>

                <div class="bg-white p-6 rounded-3xl shadow-sm border border-emerald-50">
                    <h3 class="font-black text-emerald-900 mb-4 text-sm uppercase">üìÖ Evoluci√≥n por Jornadas</h3>
                    <div id="journey-stats" class="space-y-2 text-xs"></div>
                </div>
            </section>
        </div>

        <footer class="mt-12 mb-6 text-center px-4">
            <div class="inline-block bg-white px-6 py-3 rounded-2xl shadow-sm border border-slate-100">
                <p class="text-slate-400 text-[10px] md:text-xs font-medium italic">
                    app elaborada para uso educativo por <span class="text-emerald-600 font-black">@luisgeria</span>
                    <span class="text-slate-300 mx-2">¬∑</span>
                    <span class="text-emerald-600 font-bold">Versi√≥n Mejorada 2.0</span>
                </p>
            </div>
        </footer>
    </main>

    <!-- BACKUP MODAL -->
    <div id="backup-modal" class="hidden fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-3xl max-w-md w-full shadow-2xl">
            <h3 class="text-xl font-black text-emerald-900 mb-4">üíæ Backup y Restauraci√≥n</h3>
            <div class="space-y-3">
                <button onclick="downloadBackup()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl transition">
                    üì• Descargar Backup (JSON)
                </button>
                <div>
                    <input type="file" id="backup-input" accept=".json" class="hidden" onchange="restoreBackup(this)">
                    <label for="backup-input" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl cursor-pointer transition text-center">
                        üì§ Restaurar desde Backup
                    </label>
                </div>
                <button onclick="closeBackupModal()" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-3 rounded-xl transition">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlW7S4tpn4YYkoov1Uq93KFmT8cY8Uzms",
            authDomain: "app-reserva-de-portatiles.firebaseapp.com",
            databaseURL: "https://app-reserva-de-portatiles-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "app-reserva-de-portatiles",
            storageBucket: "app-reserva-de-portatiles.firebasestorage.app",
            messagingSenderId: "170712420790",
            appId: "1:170712420790:web:e52d1831be2985c6af3117"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const stateRef = ref(database, 'campeonato-torneo/state');

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        let participants = [];
        let state = {
            isAdmin: false,
            teams: [],
            matches: [],
            teamNames: {},
            playoffs: {
                quarters: [
                    { id: 'q1', t1: null, t2: null, s1: null, s2: null, winner: null },
                    { id: 'q2', t1: null, t2: null, s1: null, s2: null, winner: null },
                    { id: 'q3', t1: null, t2: null, s1: null, s2: null, winner: null },
                    { id: 'q4', t1: null, t2: null, s1: null, s2: null, winner: null }
                ],
                semis: [
                    { id: 's1', t1: null, t2: null, s1: null, s2: null, winner: null },
                    { id: 's2', t1: null, t2: null, s1: null, s2: null, winner: null }
                ],
                final: { id: 'f1', t1: null, t2: null, s1: null, s2: null, winner: null }
            }
        };

        // ============================================
        // FIREBASE PERSISTENCE (reemplaza localStorage)
        // ============================================
        function saveState() {
            try {
                set(stateRef, state)
                    .then(() => {
                        showSaveIndicator();
                    })
                    .catch((error) => {
                        console.error('Error saving to Firebase:', error);
                        showToast('Error al guardar', 'error');
                    });
            } catch (e) {
                console.error('Error saving state:', e);
                showToast('Error al guardar', 'error');
            }
        }

        function loadState() {
            return new Promise((resolve) => {
                onValue(stateRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const currentAdmin = state.isAdmin;
                        state = { ...data, isAdmin: currentAdmin };
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                }, { onlyOnce: true });
            });
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${type === 'success' ? '‚úì' : '‚ö†Ô∏è'}</span>
                    <span class="font-bold text-sm">${message}</span>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // LOGIN & INITIALIZATION
        // ============================================
        async function checkLogin() {
            if (document.getElementById('pass-input').value === "112233") {
                state.isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('login-overlay').classList.add('hidden');
                
                const hasData = await loadState();
                if (hasData && state.teams.length > 0) {
                    showApp();
                    showToast('Sesi√≥n restaurada');
                } else {
                    document.getElementById('step-upload').classList.remove('hidden');
                }
            } else {
                showToast('Clave incorrecta', 'error');
            }
        }

        async function enterAsGuest() {
            document.getElementById('login-overlay').classList.add('hidden');
            
            const hasData = await loadState();
            if (hasData && state.teams.length > 0) {
                showApp();
            } else {
                document.getElementById('guest-empty').classList.remove('hidden');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active-tab');
            
            // Refresh dynamic content
            if(tabId === 'tab-calendar') renderCalendar();
            if(tabId === 'tab-standings') updateStandings();
            if(tabId === 'tab-playoffs') renderPlayoffs();
            if(tabId === 'tab-stats') renderStats();
            
            btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        // ============================================
        // FILE HANDLING
        // ============================================
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            document.getElementById('loading-indicator').classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    
                    participants = json.map(row => {
                        const keys = Object.keys(row);
                        const nK = keys.find(k => k.toLowerCase().match(/nombre|alumno/)) || keys[0];
                        const cK = keys.find(k => k.toLowerCase().match(/curso|nivel|a√±o/)) || keys[1];
                        const gK = keys.find(k => k.toLowerCase().match(/genero|sexo|gen|g√©nero/)) || keys[2];
                        
                        let gVal = String(row[gK] || '').toLowerCase().trim();
                        let gender = 'h';
                        
                        // Improved gender detection
                        if (gVal.startsWith('f') || gVal.includes('mujer') || gVal.includes('chica') || 
                            gVal.includes('femenino') || gVal === 'm' || gVal.includes('ni√±a')) {
                            gender = 'm';
                        }
                        
                        return { 
                            n: String(row[nK]).trim(), 
                            c: parseInt(row[cK]) || 0, 
                            g: gender 
                        };
                    }).filter(p => p.n && p.n !== 'undefined');

                    if (participants.length === 0) {
                        throw new Error('No se detectaron alumnos en el archivo');
                    }

                    renderPreview();
                    showToast(`${participants.length} alumnos cargados`);
                } catch (error) {
                    showToast('Error al procesar el archivo', 'error');
                    console.error(error);
                } finally {
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function loadMockData() {
            document.getElementById('loading-indicator').classList.remove('hidden');
            
            setTimeout(() => {
                participants = [];
                const nombres = [
                    'Mar√≠a Garc√≠a', 'Carlos L√≥pez', 'Ana Mart√≠nez', 'David Rodr√≠guez',
                    'Laura Fern√°ndez', 'Javier S√°nchez', 'Paula Jim√©nez', 'Miguel Torres',
                    'Sara Moreno', 'Pablo Ruiz', 'Luc√≠a Navarro', 'Jorge D√≠az',
                    'Carmen √Ålvarez', 'Daniel Romero', 'Elena Mu√±oz', 'Alberto Iglesias',
                    'Marta Santos', 'Ra√∫l Gil', 'Cristina Ortega', 'Sergio Rubio',
                    'Natalia Castro', 'Adri√°n Vargas', 'Beatriz Ramos', 'Hugo Molina',
                    'Sof√≠a Morales', 'Iv√°n Su√°rez', 'Julia Ortiz', 'Marcos Delgado',
                    'Andrea Castro', 'Diego Vega', 'Clara Ram√≠rez', 'Antonio M√©ndez',
                    'Isabel Herrera', 'Francisco Aguilar', 'Roc√≠o Serrano', 'Manuel Blanco',
                    'Silvia Pascual', 'Rub√©n Cort√©s', 'Nuria Guerrero', '√ìscar Medina'
                ];
                
                for(let i = 0; i < 40; i++) {
                    participants.push({ 
                        n: nombres[i] || `Alumno ${i+1}`, 
                        c: [3, 4, 5, 6][i % 4], 
                        g: i % 2 ? 'h' : 'm' 
                    });
                }
                
                renderPreview();
                document.getElementById('loading-indicator').classList.add('hidden');
                showToast('Datos de prueba cargados');
            }, 500);
        }

        function renderPreview() {
            document.getElementById('count-alumni').innerText = participants.length;
            document.getElementById('count-captains').innerText = participants.filter(p => p.c === 6).length;
            document.getElementById('count-h').innerText = participants.filter(p => p.g === 'h').length;
            document.getElementById('count-m').innerText = participants.filter(p => p.g === 'm').length;

            const body = document.getElementById('preview-list-body');
            body.innerHTML = participants.map(p => `
                <tr class="hover:bg-slate-50 transition-colors animate-slide-in">
                    <td class="p-3 pl-5 font-bold text-slate-700">${p.n}</td>
                    <td class="p-3 text-center text-slate-500 font-black">${p.c}¬∫</td>
                    <td class="p-3 text-center">
                        <span class="px-2 py-0.5 rounded-full text-[9px] font-black uppercase ${p.g === 'm' ? 'bg-pink-100 text-pink-600' : 'bg-blue-100 text-blue-600'}">
                            ${p.g === 'm' ? 'Chica' : 'Chico'}
                        </span>
                    </td>
                </tr>
            `).join('');

            document.getElementById('file-preview').classList.remove('hidden');
        }

        // ============================================
        // TEAM CREATION
        // ============================================
        function confirmParticipants() {
            if (participants.length < 10) {
                showToast('Se necesitan al menos 10 alumnos', 'error');
                return;
            }

            const caps = participants.filter(p => p.c === 6).sort(() => Math.random() - 0.5);
            const others = participants.filter(p => p.c !== 6);
            const boys = others.filter(p => p.g === 'h').sort(() => Math.random() - 0.5);
            const girls = others.filter(p => p.g === 'm').sort(() => Math.random() - 0.5);

            // Create 10 teams
            state.teams = Array.from({length: 10}, (_, i) => ({ id: i + 1, members: [] }));
            
            // Distribute captains
            caps.forEach((p, i) => {
                if (i < 10) {
                    state.teams[i].members.push({...p, isCaptain: true});
                }
            });
            
            // Distribute boys
            boys.forEach((p, i) => state.teams[i % 10].members.push(p));
            
            // Distribute girls (reverse order for balance)
            girls.forEach((p, i) => state.teams[9 - (i % 10)].members.push(p));

            state.matches = generateRoundRobin();
            state.teamNames = {}; // Reset team names
            
            saveState();
            renderTeams();
            renderCalendar();
            populateTeamFilter();
            showApp();
            showToast('¬°Torneo creado con √©xito!');
        }

        function generateRoundRobin() {
            const ids = state.teams.map(t => t.id);
            let matches = [];
            
            // Round-robin algorithm
            for (let j = 0; j < 9; j++) {
                for (let i = 0; i < 5; i++) {
                    matches.push({ 
                        id: matches.length, 
                        t1: ids[i], 
                        t2: ids[9 - i], 
                        s1: null, 
                        s2: null, 
                        day: j + 1 
                    });
                }
                ids.splice(1, 0, ids.pop());
            }
            
            return matches;
        }

        // ============================================
        // TEAM MANAGEMENT
        // ============================================
        function updateTeamName(teamId, newName) {
            state.teamNames[teamId] = newName;
            saveState();
        }

        function getTeamName(teamId) {
            return state.teamNames[teamId] || `Equipo ${teamId}`;
        }

        function renderTeams() {
            const grid = document.getElementById('teams-grid');
            grid.innerHTML = state.teams.map(team => `
                <div class="bg-white border-2 border-emerald-50 p-4 rounded-[2rem] shadow-sm hover:shadow-md transition-shadow animate-slide-in">
                    <div class="mb-3 px-1">
                        ${state.isAdmin ? 
                            `<input 
                                type="text" 
                                value="${state.teamNames[team.id] || ''}" 
                                oninput="updateTeamName(${team.id}, this.value)" 
                                placeholder="Equipo ${team.id}" 
                                class="w-full font-black text-emerald-800 bg-transparent border-b-2 border-emerald-100 focus:border-emerald-500 outline-none text-xs italic uppercase transition-colors px-1 py-1"
                                aria-label="Nombre del equipo ${team.id}">` :
                            `<div class="font-black text-emerald-800 uppercase italic text-xs">${getTeamName(team.id)}</div>`
                        }
                        <div class="text-[9px] text-slate-400 font-bold mt-1">${team.members.length} miembros</div>
                    </div>
                    <div class="space-y-1 max-h-48 overflow-y-auto">
                        ${team.members.map(m => `
                            <div class="flex justify-between items-center text-[10px] py-1.5 px-2 rounded-lg transition-colors ${m.isCaptain ? 'bg-amber-50 font-bold border border-amber-200' : 'hover:bg-slate-50'}">
                                <span class="truncate flex items-center gap-1">
                                    ${m.isCaptain ? '<span class="text-amber-500">üëë</span>' : ''}
                                    <span class="${m.g === 'm' ? 'text-pink-500' : 'text-blue-500'}">‚óè</span> 
                                    ${m.n}
                                </span>
                                <span class="text-emerald-700 font-black text-[9px]">${m.c}¬∫</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // CALENDAR & MATCHES
        // ============================================
        function populateTeamFilter() {
            const select = document.getElementById('team-filter');
            select.innerHTML = '<option value="">Todos los equipos</option>' +
                state.teams.map(t => `<option value="${t.id}">${getTeamName(t.id)}</option>`).join('');
        }

        function renderCalendar() {
            const filterTeam = document.getElementById('team-filter')?.value;
            const days = {};
            
            let filteredMatches = state.matches;
            if (filterTeam) {
                const teamId = parseInt(filterTeam);
                filteredMatches = state.matches.filter(m => m.t1 === teamId || m.t2 === teamId);
            }
            
            filteredMatches.forEach(m => { 
                if(!days[m.day]) days[m.day] = []; 
                days[m.day].push(m); 
            });

            // Update match counters
            const completed = state.matches.filter(m => m.s1 !== null && m.s2 !== null).length;
            document.getElementById('matches-completed').innerText = completed;
            document.getElementById('matches-total').innerText = state.matches.length;

            document.getElementById('calendar-container').innerHTML = Object.keys(days).map(day => `
                <div class="bg-white border-2 border-emerald-50 rounded-[2rem] overflow-hidden shadow-sm hover:shadow-md transition-shadow animate-slide-in">
                    <div class="bg-emerald-800 text-white px-5 py-3 text-[10px] font-black uppercase flex justify-between items-center">
                        <span>Jornada ${day}</span>
                        <span class="text-emerald-200">${days[day].filter(m => m.s1 !== null && m.s2 !== null).length}/${days[day].length}</span>
                    </div>
                    <div class="p-4 space-y-3">
                        ${days[day].map(m => {
                            const isCompleted = m.s1 !== null && m.s2 !== null;
                            return `
                            <div class="flex items-center gap-2 p-2 rounded-xl transition-all ${isCompleted ? 'match-completed' : 'match-pending'}">
                                <div class="flex-1 text-right font-black text-[10px] truncate text-emerald-900 italic">
                                    ${getTeamName(m.t1)}
                                </div>
                                <div class="flex gap-1.5 items-center">
                                    <input 
                                        type="number" 
                                        value="${m.s1 ?? ''}" 
                                        ${state.isAdmin ? '' : 'disabled'} 
                                        onchange="updateScore(${m.id}, 's1', this.value)" 
                                        min="0"
                                        max="99"
                                        class="w-10 h-10 text-center border-2 ${isCompleted ? 'border-emerald-200 bg-white' : 'border-slate-200'} rounded-xl font-bold text-sm focus:border-emerald-500 outline-none transition-colors"
                                        aria-label="Goles ${getTeamName(m.t1)}">
                                    <span class="text-slate-300 font-black">-</span>
                                    <input 
                                        type="number" 
                                        value="${m.s2 ?? ''}" 
                                        ${state.isAdmin ? '' : 'disabled'} 
                                        onchange="updateScore(${m.id}, 's2', this.value)" 
                                        min="0"
                                        max="99"
                                        class="w-10 h-10 text-center border-2 ${isCompleted ? 'border-emerald-200 bg-white' : 'border-slate-200'} rounded-xl font-bold text-sm focus:border-emerald-500 outline-none transition-colors"
                                        aria-label="Goles ${getTeamName(m.t2)}">
                                </div>
                                <div class="flex-1 text-left font-black text-[10px] truncate text-emerald-900 italic">
                                    ${getTeamName(m.t2)}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `).join('');
        }

        function updateScore(id, k, v) {
            const m = state.matches.find(x => x.id === id);
            if (m) {
                const val = v === "" ? null : parseInt(v);
                
                // Validate score
                if (val !== null && (val < 0 || val > 99)) {
                    showToast('Puntuaci√≥n inv√°lida', 'error');
                    return;
                }
                
                m[k] = val;
                saveState();
                
                // If both scores are set, update standings
                if (m.s1 !== null && m.s2 !== null) {
                    updateStandings();
                    renderCalendar(); // Refresh to show completed state
                    showToast('Resultado guardado');
                }
            }
        }

        function simulateScores() {
            if (!confirm('¬øSimular resultados aleatorios para todos los partidos?')) return;
            
            state.matches.forEach(m => { 
                m.s1 = Math.floor(Math.random() * 4); 
                m.s2 = Math.floor(Math.random() * 4); 
            });
            
            saveState();
            renderCalendar();
            updateStandings();
            renderPlayoffs();
            showToast('Resultados simulados');
        }

        // ============================================
        // STANDINGS
        // ============================================
        function updateStandings() {
            const stats = state.teams.map(t => ({ 
                id: t.id, 
                name: getTeamName(t.id), 
                pj: 0, 
                v: 0, 
                e: 0, 
                d: 0, 
                gf: 0, 
                gc: 0, 
                pts: 0 
            }));

            state.matches.forEach(m => {
                if (m.s1 !== null && m.s2 !== null) {
                    const t1 = stats.find(s => s.id === m.t1);
                    const t2 = stats.find(s => s.id === m.t2);
                    
                    t1.pj++; 
                    t2.pj++;
                    t1.gf += m.s1; 
                    t1.gc += m.s2;
                    t2.gf += m.s2; 
                    t2.gc += m.s1;
                    
                    if (m.s1 > m.s2) { 
                        t1.pts += 3; 
                        t1.v++;
                        t2.pts += 1; 
                        t2.d++;
                    } else if (m.s1 < m.s2) { 
                        t2.pts += 3; 
                        t2.v++;
                        t1.pts += 1; 
                        t1.d++;
                    } else { 
                        t1.pts += 2; 
                        t2.pts += 2; 
                        t1.e++;
                        t2.e++;
                    }
                }
            });

            // Sort by points, then goal difference, then goals for
            stats.sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                const diffA = a.gf - a.gc;
                const diffB = b.gf - b.gc;
                if (diffB !== diffA) return diffB - diffA;
                return b.gf - a.gf;
            });

            document.getElementById('standings-body').innerHTML = stats.map((s, i) => {
                const isPlayoff = i < 8;
                return `
                <tr class="text-xs hover:bg-emerald-50/30 transition-colors">
                    <td class="p-3 text-center font-bold sticky left-0 bg-white ${isPlayoff ? 'text-emerald-600' : 'text-slate-400'}">
                        ${i + 1}
                    </td>
                    <td class="p-3 font-black text-emerald-900 italic sticky left-8 bg-white">
                        ${isPlayoff ? 'üèÜ ' : ''}${s.name}
                    </td>
                    <td class="p-3 text-center font-bold text-slate-600">${s.pj}</td>
                    <td class="p-3 text-center font-bold text-emerald-600">${s.v}</td>
                    <td class="p-3 text-center font-bold text-amber-600">${s.e}</td>
                    <td class="p-3 text-center font-bold text-red-400">${s.d}</td>
                    <td class="p-3 text-center font-bold text-blue-600">${s.gf}</td>
                    <td class="p-3 text-center font-bold text-pink-600">${s.gc}</td>
                    <td class="p-3 text-center font-bold ${s.gf - s.gc >= 0 ? 'text-emerald-600' : 'text-red-400'}">
                        ${s.gf - s.gc > 0 ? '+' : ''}${s.gf - s.gc}
                    </td>
                    <td class="p-3 text-center bg-emerald-50 font-black text-emerald-700 text-base">
                        ${s.pts}
                    </td>
                </tr>
            `}).join('');

            return stats;
        }

        // ============================================
        // PLAYOFFS
        // ============================================
        function renderPlayoffs() {
            const stats = updateStandings();
            const top8 = stats.slice(0, 8);

            // Update playoff matchups
            if (top8.length === 8) {
                state.playoffs.quarters[0].t1 = top8[0]?.id;
                state.playoffs.quarters[0].t2 = top8[7]?.id;
                state.playoffs.quarters[1].t1 = top8[3]?.id;
                state.playoffs.quarters[1].t2 = top8[4]?.id;
                state.playoffs.quarters[2].t1 = top8[1]?.id;
                state.playoffs.quarters[2].t2 = top8[6]?.id;
                state.playoffs.quarters[3].t1 = top8[2]?.id;
                state.playoffs.quarters[3].t2 = top8[5]?.id;
            }

            // Update semifinals based on quarter winners
            if (state.playoffs.quarters[0].winner && state.playoffs.quarters[1].winner) {
                state.playoffs.semis[0].t1 = state.playoffs.quarters[0].winner;
                state.playoffs.semis[0].t2 = state.playoffs.quarters[1].winner;
            }
            if (state.playoffs.quarters[2].winner && state.playoffs.quarters[3].winner) {
                state.playoffs.semis[1].t1 = state.playoffs.quarters[2].winner;
                state.playoffs.semis[1].t2 = state.playoffs.quarters[3].winner;
            }

            // Update final
            if (state.playoffs.semis[0].winner && state.playoffs.semis[1].winner) {
                state.playoffs.final.t1 = state.playoffs.semis[0].winner;
                state.playoffs.final.t2 = state.playoffs.semis[1].winner;
            }

            document.getElementById('playoff-bracket').innerHTML = `
                <!-- CUARTOS -->
                <div class="flex flex-col justify-around gap-6 min-w-[200px]">
                    <div class="text-[9px] font-black text-emerald-700 uppercase text-center mb-2">Cuartos</div>
                    ${state.playoffs.quarters.map((q, idx) => renderPlayoffMatch(q, 'quarter', idx)).join('')}
                </div>

                <!-- SEMIFINALES -->
                <div class="flex flex-col justify-around gap-16 min-w-[200px]">
                    <div class="text-[9px] font-black text-emerald-700 uppercase text-center mb-2">Semifinales</div>
                    ${state.playoffs.semis.map((s, idx) => renderPlayoffMatch(s, 'semi', idx)).join('')}
                </div>

                <!-- FINAL -->
                <div class="flex flex-col justify-center min-w-[240px]">
                    <div class="text-[9px] font-black text-emerald-700 uppercase text-center mb-4">Final</div>
                    ${renderPlayoffMatch(state.playoffs.final, 'final', 0)}
                    ${state.playoffs.final.winner ? `
                        <div class="mt-6 text-center">
                            <div class="inline-block bg-gradient-to-br from-amber-400 to-amber-600 text-white px-8 py-4 rounded-3xl shadow-2xl">
                                <div class="text-4xl mb-2">üèÜ</div>
                                <div class="text-xs font-bold opacity-90">CAMPE√ìN</div>
                                <div class="text-lg font-black">${getTeamName(state.playoffs.final.winner)}</div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderPlayoffMatch(match, stage, idx) {
            const t1Name = match.t1 ? getTeamName(match.t1) : 'Esperando...';
            const t2Name = match.t2 ? getTeamName(match.t2) : 'Esperando...';
            const canEdit = state.isAdmin && match.t1 && match.t2;
            const isCompleted = match.s1 !== null && match.s2 !== null;

            return `
                <div class="playoff-match border-2 ${isCompleted ? 'border-emerald-200 bg-emerald-50' : 'border-slate-200'} rounded-2xl bg-white p-3 text-[10px] font-black shadow-sm hover:shadow-md transition-all">
                    <div class="flex items-center justify-between mb-2 pb-2 border-b ${match.winner === match.t1 ? 'border-emerald-300 bg-emerald-100' : 'border-slate-100'}">
                        <div class="flex-1 ${match.t1 ? 'text-emerald-900' : 'text-slate-300'} italic truncate">
                            ${match.winner === match.t1 ? 'üëë ' : ''}${t1Name}
                        </div>
                        <input 
                            type="number" 
                            value="${match.s1 ?? ''}" 
                            ${canEdit ? '' : 'disabled'} 
                            onchange="updatePlayoffScore('${stage}', ${idx}, 's1', this.value)"
                            min="0"
                            max="99"
                            class="w-8 h-8 text-center border rounded-lg font-bold text-xs ${canEdit ? 'border-emerald-200' : 'border-slate-200 bg-slate-50'}"
                            aria-label="Goles ${t1Name}">
                    </div>
                    <div class="flex items-center justify-between ${match.winner === match.t2 ? 'pt-2 border-t border-emerald-300 bg-emerald-100 -mx-3 -mb-3 px-3 pb-3 rounded-b-2xl' : ''}">
                        <div class="flex-1 ${match.t2 ? 'text-emerald-900' : 'text-slate-300'} italic truncate">
                            ${match.winner === match.t2 ? 'üëë ' : ''}${t2Name}
                        </div>
                        <input 
                            type="number" 
                            value="${match.s2 ?? ''}" 
                            ${canEdit ? '' : 'disabled'} 
                            onchange="updatePlayoffScore('${stage}', ${idx}, 's2', this.value)"
                            min="0"
                            max="99"
                            class="w-8 h-8 text-center border rounded-lg font-bold text-xs ${canEdit ? 'border-emerald-200' : 'border-slate-200 bg-slate-50'}"
                            aria-label="Goles ${t2Name}">
                    </div>
                </div>
            `;
        }

        function updatePlayoffScore(stage, idx, key, value) {
            let match;
            if (stage === 'quarter') match = state.playoffs.quarters[idx];
            else if (stage === 'semi') match = state.playoffs.semis[idx];
            else match = state.playoffs.final;

            const val = value === "" ? null : parseInt(value);
            
            if (val !== null && (val < 0 || val > 99)) {
                showToast('Puntuaci√≥n inv√°lida', 'error');
                return;
            }

            match[key] = val;

            // Determine winner
            if (match.s1 !== null && match.s2 !== null) {
                if (match.s1 > match.s2) {
                    match.winner = match.t1;
                } else if (match.s2 > match.s1) {
                    match.winner = match.t2;
                } else {
                    // In case of draw, ask for penalty shootout or extra time
                    if (confirm('Empate. ¬øEl ganador es ' + getTeamName(match.t1) + '? (No = ' + getTeamName(match.t2) + ')')) {
                        match.winner = match.t1;
                    } else {
                        match.winner = match.t2;
                    }
                }
                showToast('Ganador: ' + getTeamName(match.winner));
            } else {
                match.winner = null;
            }

            saveState();
            renderPlayoffs();
        }

        // ============================================
        // STATISTICS
        // ============================================
        function renderStats() {
            const stats = updateStandings();
            
            // Total goals
            let totalGoals = 0;
            let draws = 0;
            const completedMatches = state.matches.filter(m => m.s1 !== null && m.s2 !== null);
            
            completedMatches.forEach(m => {
                totalGoals += m.s1 + m.s2;
                if (m.s1 === m.s2) draws++;
            });

            const avgGoals = completedMatches.length > 0 ? (totalGoals / completedMatches.length).toFixed(1) : 0;

            document.getElementById('stat-total-goals').innerText = totalGoals;
            document.getElementById('stat-avg-goals').innerText = avgGoals;
            document.getElementById('stat-draws').innerText = draws;

            // Top scorers
            const topScorers = [...stats].sort((a, b) => b.gf - a.gf).slice(0, 5);
            document.getElementById('top-scorers').innerHTML = topScorers.map((t, i) => `
                <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-emerald-600">${i + 1}</span>
                        <span class="font-bold text-sm text-emerald-900">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚öΩ</span>
                        <span class="text-xl font-black text-emerald-700">${t.gf}</span>
                    </div>
                </div>
            `).join('');

            // Best defenses
            const bestDefenses = [...stats].sort((a, b) => a.gc - b.gc).slice(0, 5);
            document.getElementById('best-defenses').innerHTML = bestDefenses.map((t, i) => `
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-blue-600">${i + 1}</span>
                        <span class="font-bold text-sm text-blue-900">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <span class="text-xl font-black text-blue-700">${t.gc}</span>
                        <span class="text-xs text-blue-500">en contra</span>
                    </div>
                </div>
            `).join('');

            // Journey stats
            const journeyStats = {};
            for (let day = 1; day <= 9; day++) {
                const dayMatches = state.matches.filter(m => m.day === day && m.s1 !== null && m.s2 !== null);
                const goals = dayMatches.reduce((sum, m) => sum + m.s1 + m.s2, 0);
                journeyStats[day] = { total: dayMatches.length, goals };
            }

            document.getElementById('journey-stats').innerHTML = Object.entries(journeyStats).map(([day, data]) => `
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors">
                    <span class="font-bold text-slate-700">Jornada ${day}</span>
                    <div class="flex gap-4 text-[10px]">
                        <span class="text-slate-500">${data.total} partidos</span>
                        <span class="font-black text-emerald-600">${data.goals} goles</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // EXPORT & BACKUP
        // ============================================
        function exportToExcel() {
            const stats = updateStandings();
            
            // Prepare data
            const standingsData = stats.map((s, i) => ({
                'Posici√≥n': i + 1,
                'Equipo': s.name,
                'PJ': s.pj,
                'V': s.v,
                'E': s.e,
                'D': s.d,
                'GF': s.gf,
                'GC': s.gc,
                'DIF': s.gf - s.gc,
                'PTS': s.pts
            }));

            const matchesData = state.matches.map(m => ({
                'Jornada': m.day,
                'Local': getTeamName(m.t1),
                'Goles Local': m.s1 ?? '-',
                'Goles Visitante': m.s2 ?? '-',
                'Visitante': getTeamName(m.t2)
            }));

            // Create workbook
            const wb = XLSX.utils.book_new();
            const wsStandings = XLSX.utils.json_to_sheet(standingsData);
            const wsMatches = XLSX.utils.json_to_sheet(matchesData);
            
            XLSX.utils.book_append_sheet(wb, wsStandings, 'Clasificaci√≥n');
            XLSX.utils.book_append_sheet(wb, wsMatches, 'Partidos');
            
            // Download
            XLSX.writeFile(wb, `Campeonato_Cementerio_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Excel exportado correctamente');
        }

        function showBackupModal() {
            document.getElementById('backup-modal').classList.remove('hidden');
        }

        function closeBackupModal() {
            document.getElementById('backup-modal').classList.add('hidden');
        }

        function downloadBackup() {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_torneo_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup descargado');
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.teams || !backup.matches) {
                        throw new Error('Formato de backup inv√°lido');
                    }

                    if (confirm('¬øRestaurar este backup? Se perder√°n los datos actuales.')) {
                        state = { ...backup, isAdmin: state.isAdmin };
                        saveState();
                        location.reload();
                    }
                } catch (error) {
                    showToast('Error al restaurar backup', 'error');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showApp() {
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('guest-empty').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('nav-tabs').classList.remove('hidden');
            
            renderTeams();
            renderCalendar();
            updateStandings();
            renderPlayoffs();
            renderStats();
            populateTeamFilter();
        }

        function clearAllData() {
            if (confirm('¬øEst√°s seguro? Se borrar√°n TODOS los datos del torneo.')) {
                if (confirm('Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                    remove(stateRef)
                        .then(() => {
                            showToast('Datos eliminados');
                            setTimeout(() => location.reload(), 1000);
                        })
                        .catch((error) => {
                            console.error('Error deleting data:', error);
                            showToast('Error al eliminar', 'error');
                        });
                }
            }
        }

        // ============================================
        // INITIALIZE ON LOAD
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            // Try to load saved state for guest view
            const hasData = await loadState();
            if (hasData && state.teams.length > 0 && !state.isAdmin) {
                console.log('Saved tournament found');
            }
        });

        // ============================================
        // PWA INSTALLATION
        // ============================================
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.add('show');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) {
                return;
            }
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            document.getElementById('installBtn').classList.remove('show');
        });

        window.addEventListener('appinstalled', () => {
            console.log('PWA was installed');
            document.getElementById('installBtn').classList.remove('show');
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw-campeonato.js')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.log('Service Worker registration failed', err));
        }

        // Make functions global for onclick handlers
        window.checkLogin = checkLogin;
        window.enterAsGuest = enterAsGuest;
        window.handleFile = handleFile;
        window.loadMockData = loadMockData;
        window.showTab = showTab;
        window.renderTeams = renderTeams;
        window.renderCalendar = renderCalendar;
        window.updateStandings = updateStandings;
        window.renderPlayoffs = renderPlayoffs;
        window.renderStats = renderStats;
        window.updateMatchScore = updateMatchScore;
        window.setPlayoffScore = setPlayoffScore;
        window.clearAllData = clearAllData;
        window.exportToExcel = exportToExcel;
        window.showBackupModal = showBackupModal;
        window.closeBackupModal = closeBackupModal;
        window.downloadBackup = downloadBackup;
        window.restoreBackup = restoreBackup;
        window.simulateScores = simulateScores;
    </script>
</body>
</html>
