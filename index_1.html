<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistema de gesti√≥n del campeonato de cementerio en tiempo real para CEIP Puente de Simancas">
    <meta name="theme-color" content="#10b981">
    
    <title>Campeonato Cementerio - CEIP Puente de Simancas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- ‚≠ê FIREBASE SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .admin-only { display: none; }
        .is-admin .admin-only { display: block; }
        ::-webkit-scrollbar { height: 6px; width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        .bracket-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        input[type="number"], input[type="text"], input[type="password"] { font-size: 16px !important; }
        .active-tab { background-color: #065f46 !important; border: 1px solid #10b981 !important; opacity: 1 !important; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 1.5s ease-in-out infinite; }
        .save-indicator { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: #10b981; 
            color: white; 
            padding: 12px 20px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); 
        }
        .toast { 
            position: fixed; 
            top: 80px; 
            right: 20px; 
            background: white; 
            padding: 16px 20px; 
            border-radius: 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); 
            z-index: 1000; 
            border-left: 4px solid #10b981; 
            animation: slideIn 0.3s ease-out; 
        }
        .match-completed { background: #f0fdf4 !important; }
        .match-pending { background: white !important; }
        .playoff-match { min-height: 80px; }
        .connection-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
            transition: background-color 0.3s; 
        }
        
        /* Loading spinner */
        .spinner { 
            border: 3px solid #f3f3f3; 
            border-top: 3px solid #10b981; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
    </style>
</head>
<body class="bg-stone-50 min-h-screen text-slate-900 overflow-x-hidden">

    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container"></div>

    <!-- SAVE INDICATOR -->
    <div id="save-indicator" class="save-indicator hidden">‚úì Sincronizado</div>

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-emerald-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-2xl max-w-sm w-full text-center border-4 border-emerald-500">
            <div class="text-5xl mb-4">üè´</div>
            <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-1">CEIP Puente de Simancas</h2>
            <p class="text-emerald-600 font-bold text-xs mb-6 uppercase tracking-widest">Torneo de Cementerio</p>
            
            <!-- Connection Status -->
            <div class="mb-4 flex items-center justify-center gap-2">
                <span id="login-conn-dot" class="connection-dot bg-slate-300"></span>
                <span id="login-conn-text" class="text-[10px] font-bold text-slate-400 uppercase">Conectando...</span>
            </div>
            
            <input type="password" id="pass-input" placeholder="Clave Profesor" 
                class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-4 text-center text-xl tracking-widest focus:border-emerald-500 outline-none transition-all"
                onkeypress="if(event.key==='Enter') checkLogin()">
            <div class="flex flex-col gap-3">
                <button onclick="checkLogin()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-2xl transition shadow-lg active:scale-95">
                    Acceso Profesor
                </button>
                <button onclick="enterAsGuest()" class="w-full text-slate-400 font-bold py-2 text-sm hover:text-emerald-600 transition">
                    Ver como Espectador
                </button>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bg-emerald-700 text-white shadow-lg sticky top-0 z-50 border-b-4 border-emerald-800">
        <div class="max-w-5xl mx-auto px-4">
            <div class="flex flex-col py-3 gap-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl md:text-3xl">üéæ</span>
                        <div>
                            <h1 class="text-base md:text-lg font-black tracking-tighter uppercase italic leading-tight">Campeonato Cementerio</h1>
                            <p class="text-[9px] md:text-[10px] font-medium opacity-90">Puente de Simancas ¬∑ 2025/2026</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="flex items-center gap-1 text-[10px] font-bold">
                            <span id="conn-dot" class="connection-dot bg-slate-300"></span>
                            <span id="conn-text" class="hidden md:inline">Conectando...</span>
                        </span>
                        <div class="admin-only flex gap-2">
                            <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-800 px-3 py-2 rounded-xl text-[10px] font-bold transition" title="Exportar resultados">
                                üìä
                            </button>
                        </div>
                    </div>
                </div>
                <div id="nav-tabs" class="flex gap-2 overflow-x-auto no-scrollbar pb-1 -mx-2 px-2 hidden">
                    <button onclick="showTab('tab-setup', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap active-tab">
                        üìã EQUIPOS
                    </button>
                    <button onclick="showTab('tab-calendar', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üóìÔ∏è PARTIDOS
                    </button>
                    <button onclick="showTab('tab-standings', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üèÜ TABLA
                    </button>
                    <button onclick="showTab('tab-playoffs', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        ‚ö° FINALES
                    </button>
                    <button onclick="showTab('tab-stats', this)" class="tab-btn px-4 py-2 rounded-xl text-[10px] font-black transition-all whitespace-nowrap opacity-70">
                        üìà STATS
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-6">
        
        <!-- SECCI√ìN CARGA (ADMIN) -->
        <section id="step-upload" class="space-y-6 hidden admin-only">
            <div class="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-xl border-2 border-emerald-50 text-center">
                <div class="mb-8">
                    <div class="text-6xl mb-4">üìÇ</div>
                    <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-2">Cargar Equipos</h2>
                    <p class="text-slate-500 text-sm">Sube el archivo Excel con los equipos del campeonato</p>
                </div>
                
                <div class="mb-6">
                    <label for="excel-input" class="cursor-pointer bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-4 rounded-2xl font-bold inline-block shadow-lg transition active:scale-95">
                        Seleccionar Archivo Excel
                    </label>
                    <input type="file" id="excel-input" accept=".xlsx,.xls" class="hidden" onchange="handleFileUpload(event)">
                    <p class="mt-3 text-xs text-slate-400 font-medium">Formato: Una columna con los nombres de los equipos</p>
                </div>

                <div id="upload-preview" class="hidden mt-6">
                    <div class="bg-emerald-50 border-2 border-emerald-200 rounded-2xl p-5">
                        <h3 class="font-black text-emerald-800 mb-3 text-sm">üìã Equipos Cargados:</h3>
                        <div id="team-list-preview" class="text-left max-h-60 overflow-y-auto text-xs space-y-1"></div>
                        <button onclick="confirmUpload()" class="mt-5 w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 rounded-xl font-bold shadow-md transition active:scale-95">
                            ‚úÖ Confirmar y Generar Calendario
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VISTA GUEST (SIN DATOS) -->
        <section id="guest-empty" class="hidden">
            <div class="bg-white p-10 md:p-16 rounded-[2.5rem] shadow-xl border-2 border-emerald-50 text-center">
                <div class="text-7xl mb-6">üèÜ</div>
                <h2 class="text-2xl md:text-3xl font-black text-slate-800 mb-3">Campeonato Pr√≥ximamente</h2>
                <p class="text-slate-500 mb-6">El torneo a√∫n no ha comenzado. Espera a que el profesor cargue los equipos.</p>
                <div class="animate-pulse text-4xl">‚è≥</div>
            </div>
        </section>

        <!-- CONTENIDO PRINCIPAL -->
        <div id="main-content" class="space-y-6 hidden">
            
            <!-- TAB: EQUIPOS -->
            <section id="tab-setup" class="tab-content active">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl md:text-2xl font-black text-slate-800">üë• Equipos</h2>
                            <p class="text-xs text-slate-500 mt-1">Listado completo de equipos del campeonato</p>
                        </div>
                        <button onclick="clearAllData()" class="admin-only bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl text-xs font-bold">
                            üóëÔ∏è Borrar Todo
                        </button>
                    </div>
                    <div id="team-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                </div>
            </section>

            <!-- TAB: PARTIDOS -->
            <section id="tab-calendar" class="tab-content">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-xl md:text-2xl font-black text-slate-800">üóìÔ∏è Calendario de Partidos</h2>
                            <p class="text-xs text-slate-500 mt-1">Resultados de cada jornada</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <select id="team-filter" onchange="filterByTeam()" class="px-4 py-2 border-2 border-slate-100 rounded-xl text-xs font-bold focus:border-emerald-500 outline-none">
                                <option value="">Todos los equipos</option>
                            </select>
                            <select id="day-filter" onchange="filterByDay()" class="px-4 py-2 border-2 border-slate-100 rounded-xl text-xs font-bold focus:border-emerald-500 outline-none">
                                <option value="">Todas las jornadas</option>
                                <option value="1">Jornada 1</option>
                                <option value="2">Jornada 2</option>
                                <option value="3">Jornada 3</option>
                                <option value="4">Jornada 4</option>
                                <option value="5">Jornada 5</option>
                                <option value="6">Jornada 6</option>
                                <option value="7">Jornada 7</option>
                                <option value="8">Jornada 8</option>
                                <option value="9">Jornada 9</option>
                            </select>
                        </div>
                    </div>
                    <div id="calendar-container"></div>
                </div>
            </section>

            <!-- TAB: TABLA -->
            <section id="tab-standings" class="tab-content">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                    <div class="mb-6">
                        <h2 class="text-xl md:text-2xl font-black text-slate-800">üèÜ Clasificaci√≥n</h2>
                        <p class="text-xs text-slate-500 mt-1">Tabla de posiciones actualizada</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs md:text-sm">
                            <thead>
                                <tr class="border-b-2 border-emerald-100">
                                    <th class="pb-3 font-black text-slate-700">#</th>
                                    <th class="pb-3 font-black text-slate-700">Equipo</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">PJ</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">V</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">E</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">D</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">GF</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">GC</th>
                                    <th class="pb-3 font-black text-slate-700 text-center">DIF</th>
                                    <th class="pb-3 font-black text-slate-700 text-center bg-emerald-50 rounded-lg px-2">PTS</th>
                                </tr>
                            </thead>
                            <tbody id="standings-table"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 p-4 bg-slate-50 rounded-xl">
                        <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Leyenda</p>
                        <div class="flex flex-wrap gap-x-6 gap-y-1 text-[10px] text-slate-600">
                            <span><strong>PJ:</strong> Partidos Jugados</span>
                            <span><strong>V:</strong> Victorias</span>
                            <span><strong>E:</strong> Empates</span>
                            <span><strong>D:</strong> Derrotas</span>
                            <span><strong>GF:</strong> Goles a Favor</span>
                            <span><strong>GC:</strong> Goles en Contra</span>
                            <span><strong>DIF:</strong> Diferencia de Goles</span>
                            <span><strong>PTS:</strong> Puntos</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TAB: FINALES -->
            <section id="tab-playoffs" class="tab-content">
                <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                    <div class="mb-6">
                        <h2 class="text-xl md:text-2xl font-black text-slate-800">‚ö° Fase Final</h2>
                        <p class="text-xs text-slate-500 mt-1">Eliminatorias directas</p>
                    </div>
                    <div id="playoffs-bracket" class="bracket-scroll"></div>
                </div>
            </section>

            <!-- TAB: STATS -->
            <section id="tab-stats" class="tab-content">
                <div class="space-y-6">
                    <div class="bg-white p-6 md:p-8 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                        <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6">üìà Estad√≠sticas Generales</h2>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="bg-emerald-50 p-4 rounded-2xl text-center">
                                <div class="text-3xl font-black text-emerald-700" id="stat-total-goals">0</div>
                                <div class="text-[10px] font-bold text-emerald-600 mt-1 uppercase">Goles Totales</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-2xl text-center">
                                <div class="text-3xl font-black text-blue-700" id="stat-avg-goals">0</div>
                                <div class="text-[10px] font-bold text-blue-600 mt-1 uppercase">Promedio/Partido</div>
                            </div>
                            <div class="bg-amber-50 p-4 rounded-2xl text-center">
                                <div class="text-3xl font-black text-amber-700" id="stat-draws">0</div>
                                <div class="text-[10px] font-bold text-amber-600 mt-1 uppercase">Empates</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center gap-2">
                                <span>‚öΩ</span> Top 5 Goleadores
                            </h3>
                            <div id="top-scorers" class="space-y-2"></div>
                        </div>

                        <div class="bg-white p-6 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                            <h3 class="text-lg font-black text-slate-800 mb-4 flex items-center gap-2">
                                <span>üõ°Ô∏è</span> Top 5 Defensas
                            </h3>
                            <div id="best-defenses" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-[2rem] shadow-lg border-2 border-emerald-50">
                        <h3 class="text-lg font-black text-slate-800 mb-4">üìä Estad√≠sticas por Jornada</h3>
                        <div id="journey-stats" class="space-y-1"></div>
                    </div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // ============================================
        // ‚≠ê FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAlW7S4tpn4YYkoov1Uq93KFmT8cY8Uzms",
            authDomain: "app-reserva-de-portatiles.firebaseapp.com",
            databaseURL: "https://app-reserva-de-portatiles-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "app-reserva-de-portatiles",
            storageBucket: "app-reserva-de-portatiles.firebasestorage.app",
            messagingSenderId: "170712420790",
            appId: "1:170712420790:web:e52d1831be2985c6af3117"
        };

        // ‚≠ê INITIALIZE FIREBASE
        let firebaseEnabled = false;
        let database = null;
        let tournamentRef = null;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            tournamentRef = database.ref('tournament');
            firebaseEnabled = true;
            console.log('‚úÖ Firebase inicializado correctamente');
        } catch (error) {
            console.error('‚ùå Error al inicializar Firebase:', error);
            firebaseEnabled = false;
        }

        // ============================================
        // STATE & CONSTANTS
        // ============================================
        const PASSWORD = '112233';
        let isAdmin = false;
        let state = {
            teams: [],
            matches: [],
            playoffs: {
                semifinals: [
                    { t1: null, t2: null, s1: null, s2: null, winner: null },
                    { t1: null, t2: null, s1: null, s2: null, winner: null }
                ],
                final: { t1: null, t2: null, s1: null, s2: null, winner: null }
            }
        };

        let activeFilters = { team: '', day: '' };

        // ============================================
        // CONNECTION STATUS
        // ============================================
        function updateConnectionStatus(connected) {
            const dots = document.querySelectorAll('.connection-dot');
            const texts = document.querySelectorAll('#conn-text, #login-conn-text');
            
            dots.forEach(dot => {
                dot.style.backgroundColor = connected ? '#10b981' : '#ef4444';
            });
            
            texts.forEach(text => {
                text.textContent = connected ? 'Conectado' : 'Desconectado';
                text.style.color = connected ? '#10b981' : '#ef4444';
            });
        }

        // ============================================
        // FIREBASE SYNC
        // ============================================
        function loadFromFirebase() {
            if (!firebaseEnabled) {
                console.log('Firebase deshabilitado, usando localStorage');
                updateConnectionStatus(false);
                loadFromLocalStorage();
                return;
            }

            // Listener de conexi√≥n
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                updateConnectionStatus(snap.val() === true);
            });

            // Cargar datos
            tournamentRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        state = data;
                        localStorage.setItem('championshipState', JSON.stringify(state));
                        console.log('‚úÖ Datos cargados desde Firebase');
                        
                        if (state.teams && state.teams.length > 0) {
                            showApp();
                        }
                    } else {
                        loadFromLocalStorage();
                    }
                })
                .catch((error) => {
                    console.error('‚ùå Error al cargar desde Firebase:', error);
                    loadFromLocalStorage();
                });

            // Listener de cambios en tiempo real
            tournamentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    state = data;
                    localStorage.setItem('championshipState', JSON.stringify(state));
                    
                    // Actualizar vistas si la app est√° visible
                    if (!document.getElementById('main-content').classList.contains('hidden')) {
                        renderTeams();
                        renderCalendar();
                        updateStandings();
                        renderPlayoffs();
                        renderStats();
                    }
                }
            });
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('championshipState');
            if (saved) {
                state = JSON.parse(saved);
                if (state.teams && state.teams.length > 0) {
                    showApp();
                }
            }
        }

        function syncData() {
            // Guardar en localStorage
            localStorage.setItem('championshipState', JSON.stringify(state));

            // Guardar en Firebase
            if (firebaseEnabled) {
                tournamentRef.set(state)
                    .then(() => {
                        showSaveIndicator();
                        console.log('‚úÖ Datos sincronizados con Firebase');
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al sincronizar:', error);
                        showToast('Error al guardar en Firebase', 'error');
                    });
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('save-indicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        // ============================================
        // LOGIN & AUTHENTICATION
        // ============================================
        function checkLogin() {
            const pass = document.getElementById('pass-input').value;
            if (pass === PASSWORD) {
                isAdmin = true;
                document.body.classList.add('is-admin');
                document.getElementById('login-overlay').classList.add('hidden');
                
                if (state.teams && state.teams.length > 0) {
                    showApp();
                } else {
                    document.getElementById('step-upload').classList.remove('hidden');
                }
            } else {
                showToast('Contrase√±a incorrecta', 'error');
            }
        }

        function enterAsGuest() {
            isAdmin = false;
            document.getElementById('login-overlay').classList.add('hidden');
            
            if (state.teams && state.teams.length > 0) {
                showApp();
            } else {
                document.getElementById('guest-empty').classList.remove('hidden');
            }
        }

        // ============================================
        // NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'error' ? '#ef4444' : '#10b981';
            toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-2xl">${type === 'error' ? '‚ùå' : '‚úÖ'}</span>
                    <span class="font-bold text-sm text-slate-700">${message}</span>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
            
            document.getElementById(tabId).classList.add('active');
            btn.classList.add('active-tab');
        }

        // ============================================
        // FILE UPLOAD & PROCESSING
        // ============================================
        let tempTeams = [];

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                tempTeams = jsonData.flat().filter(name => name && name.toString().trim() !== '');

                if (tempTeams.length < 2) {
                    showToast('Se necesitan al menos 2 equipos', 'error');
                    return;
                }

                document.getElementById('team-list-preview').innerHTML = tempTeams.map((t, i) => 
                    `<div class="flex items-center gap-2 p-2 bg-white rounded-lg">
                        <span class="font-black text-emerald-600">${i + 1}</span>
                        <span class="font-bold text-slate-700">${t}</span>
                    </div>`
                ).join('');
                
                document.getElementById('upload-preview').classList.remove('hidden');
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmUpload() {
            if (tempTeams.length < 2) {
                showToast('Se necesitan al menos 2 equipos', 'error');
                return;
            }

            state.teams = tempTeams.map((name, i) => ({ id: i, name }));
            generateRoundRobinMatches();
            syncData();
            showApp();
            showToast(`${tempTeams.length} equipos cargados correctamente`);
        }

        // ============================================
        // MATCH GENERATION
        // ============================================
        function generateRoundRobinMatches() {
            const teams = [...state.teams];
            const n = teams.length;
            const rounds = n % 2 === 0 ? n - 1 : n;
            const matchesPerRound = Math.floor(n / 2);

            if (n % 2 !== 0) teams.push({ id: -1, name: 'BYE' });

            const schedule = [];
            const teamIds = teams.map(t => t.id);

            for (let round = 0; round < rounds; round++) {
                const roundMatches = [];
                for (let i = 0; i < matchesPerRound; i++) {
                    const home = teamIds[i];
                    const away = teamIds[n - 1 - i];
                    if (home !== -1 && away !== -1) {
                        roundMatches.push({
                            day: round + 1,
                            t1: home,
                            t2: away,
                            s1: null,
                            s2: null
                        });
                    }
                }
                schedule.push(...roundMatches);
                teamIds.splice(1, 0, teamIds.pop());
            }

            state.matches = schedule;
        }

        // ============================================
        // RENDERING FUNCTIONS
        // ============================================
        function renderTeams() {
            const grid = document.getElementById('team-grid');
            grid.innerHTML = state.teams.map((t, i) => `
                <div class="bg-gradient-to-br from-emerald-50 to-white p-4 rounded-2xl border-2 border-emerald-100 text-center shadow-sm hover:shadow-md transition-all">
                    <div class="text-2xl font-black text-emerald-600 mb-1">${i + 1}</div>
                    <div class="text-xs font-bold text-slate-800">${t.name}</div>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const maxDay = Math.max(...state.matches.map(m => m.day));
            
            let html = '';
            for (let day = 1; day <= maxDay; day++) {
                const dayMatches = state.matches.filter(m => m.day === day);
                
                if (activeFilters.day && parseInt(activeFilters.day) !== day) continue;
                
                let filteredMatches = dayMatches;
                if (activeFilters.team) {
                    filteredMatches = dayMatches.filter(m => 
                        m.t1 === parseInt(activeFilters.team) || m.t2 === parseInt(activeFilters.team)
                    );
                }

                if (filteredMatches.length === 0) continue;

                html += `
                    <div class="mb-6">
                        <h3 class="text-sm font-black text-slate-700 mb-3 flex items-center gap-2">
                            <span class="bg-emerald-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-xs">${day}</span>
                            Jornada ${day}
                        </h3>
                        <div class="space-y-2">
                            ${filteredMatches.map((m, idx) => {
                                const isCompleted = m.s1 !== null && m.s2 !== null;
                                return `
                                    <div class="p-4 rounded-2xl border-2 ${isCompleted ? 'match-completed border-emerald-200' : 'match-pending border-slate-100'}">
                                        <div class="grid grid-cols-[1fr_auto_1fr] gap-3 items-center">
                                            <div class="text-right">
                                                <div class="font-bold text-sm text-slate-800">${getTeamName(m.t1)}</div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                ${isAdmin ? `
                                                    <input type="number" min="0" value="${m.s1 ?? ''}" placeholder="0" 
                                                        onchange="updateScore(${day}, ${idx}, 's1', this.value)"
                                                        class="w-12 h-12 text-center font-black text-lg border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none">
                                                    <span class="font-black text-slate-400">-</span>
                                                    <input type="number" min="0" value="${m.s2 ?? ''}" placeholder="0" 
                                                        onchange="updateScore(${day}, ${idx}, 's2', this.value)"
                                                        class="w-12 h-12 text-center font-black text-lg border-2 border-slate-200 rounded-xl focus:border-emerald-500 outline-none">
                                                ` : `
                                                    <div class="flex items-center gap-2">
                                                        <span class="w-10 h-10 flex items-center justify-center font-black text-xl ${m.s1 !== null && m.s1 > m.s2 ? 'text-emerald-600' : 'text-slate-400'}">${m.s1 ?? '-'}</span>
                                                        <span class="font-black text-slate-300">-</span>
                                                        <span class="w-10 h-10 flex items-center justify-center font-black text-xl ${m.s2 !== null && m.s2 > m.s1 ? 'text-emerald-600' : 'text-slate-400'}">${m.s2 ?? '-'}</span>
                                                    </div>
                                                `}
                                            </div>
                                            <div class="text-left">
                                                <div class="font-bold text-sm text-slate-800">${getTeamName(m.t2)}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<p class="text-center text-slate-400 py-8">No hay partidos que mostrar con los filtros actuales</p>';
        }

        function updateStandings() {
            const standings = state.teams.map(t => ({
                id: t.id,
                name: t.name,
                pj: 0,
                v: 0,
                e: 0,
                d: 0,
                gf: 0,
                gc: 0,
                pts: 0
            }));

            state.matches.forEach(m => {
                if (m.s1 === null || m.s2 === null) return;

                const t1 = standings.find(s => s.id === m.t1);
                const t2 = standings.find(s => s.id === m.t2);

                t1.pj++;
                t2.pj++;
                t1.gf += m.s1;
                t1.gc += m.s2;
                t2.gf += m.s2;
                t2.gc += m.s1;

                if (m.s1 > m.s2) {
                    t1.v++;
                    t2.d++;
                    t1.pts += 3;
                } else if (m.s2 > m.s1) {
                    t2.v++;
                    t1.d++;
                    t2.pts += 3;
                } else {
                    t1.e++;
                    t2.e++;
                    t1.pts += 1;
                    t2.pts += 1;
                }
            });

            standings.sort((a, b) => {
                if (b.pts !== a.pts) return b.pts - a.pts;
                const diffA = a.gf - a.gc;
                const diffB = b.gf - b.gc;
                if (diffB !== diffA) return diffB - diffA;
                return b.gf - a.gf;
            });

            const tbody = document.getElementById('standings-table');
            tbody.innerHTML = standings.map((s, i) => {
                let posClass = '';
                if (i === 0) posClass = 'bg-yellow-50 border-l-4 border-yellow-400';
                else if (i === 1) posClass = 'bg-slate-100 border-l-4 border-slate-400';
                else if (i === 2) posClass = 'bg-orange-50 border-l-4 border-orange-400';
                else if (i < 4) posClass = 'bg-emerald-50 border-l-4 border-emerald-400';

                return `
                    <tr class="${posClass} border-b border-slate-100">
                        <td class="py-3 px-2 font-black text-slate-600">${i + 1}</td>
                        <td class="py-3 font-bold text-slate-800">${s.name}</td>
                        <td class="py-3 text-center text-slate-600">${s.pj}</td>
                        <td class="py-3 text-center text-emerald-600 font-bold">${s.v}</td>
                        <td class="py-3 text-center text-slate-500">${s.e}</td>
                        <td class="py-3 text-center text-red-500 font-bold">${s.d}</td>
                        <td class="py-3 text-center font-bold text-emerald-700">${s.gf}</td>
                        <td class="py-3 text-center font-bold text-red-600">${s.gc}</td>
                        <td class="py-3 text-center font-bold ${s.gf - s.gc >= 0 ? 'text-emerald-600' : 'text-red-600'}">${s.gf - s.gc >= 0 ? '+' : ''}${s.gf - s.gc}</td>
                        <td class="py-3 text-center font-black text-lg text-emerald-700 bg-emerald-50 rounded-lg px-2">${s.pts}</td>
                    </tr>
                `;
            }).join('');

            return standings;
        }

        function renderPlayoffs() {
            const standings = updateStandings();
            
            if (state.playoffs.semifinals[0].t1 === null && standings.length >= 4) {
                state.playoffs.semifinals[0] = { t1: standings[0].id, t2: standings[3].id, s1: null, s2: null, winner: null };
                state.playoffs.semifinals[1] = { t1: standings[1].id, t2: standings[2].id, s1: null, s2: null, winner: null };
            }

            const bracket = document.getElementById('playoffs-bracket');
            bracket.innerHTML = `
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-black text-slate-700 mb-3">üèÖ Semifinal 1</h3>
                        ${renderPlayoffMatch(state.playoffs.semifinals[0], 'sf', 0)}
                    </div>
                    <div>
                        <h3 class="text-sm font-black text-slate-700 mb-3">üèÖ Semifinal 2</h3>
                        ${renderPlayoffMatch(state.playoffs.semifinals[1], 'sf', 1)}
                    </div>
                </div>
                <div class="mt-6 max-w-md mx-auto">
                    <h3 class="text-sm font-black text-slate-700 mb-3 text-center">üèÜ FINAL</h3>
                    ${renderPlayoffMatch(state.playoffs.final, 'final', 0)}
                </div>
            `;
        }

        function renderPlayoffMatch(match, type, idx) {
            if (!match.t1 || !match.t2) {
                return '<div class="p-6 bg-slate-50 rounded-2xl text-center text-slate-400 text-sm font-bold">Esperando clasificados...</div>';
            }

            const isCompleted = match.s1 !== null && match.s2 !== null;

            return `
                <div class="p-5 rounded-2xl border-2 ${isCompleted ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-slate-200'} playoff-match">
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-sm flex-1 ${match.winner === match.t1 ? 'text-emerald-700' : 'text-slate-700'}">${getTeamName(match.t1)}</span>
                            ${isAdmin ? `
                                <input type="number" min="0" value="${match.s1 ?? ''}" placeholder="0"
                                    onchange="updatePlayoffScore('${type}', ${idx}, 's1', this.value)"
                                    class="w-12 h-10 text-center font-black border-2 border-slate-200 rounded-lg focus:border-emerald-500 outline-none ml-2">
                            ` : `
                                <span class="w-10 text-center font-black text-lg ${match.s1 !== null && match.s1 > match.s2 ? 'text-emerald-600' : 'text-slate-400'}">${match.s1 ?? '-'}</span>
                            `}
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-sm flex-1 ${match.winner === match.t2 ? 'text-emerald-700' : 'text-slate-700'}">${getTeamName(match.t2)}</span>
                            ${isAdmin ? `
                                <input type="number" min="0" value="${match.s2 ?? ''}" placeholder="0"
                                    onchange="updatePlayoffScore('${type}', ${idx}, 's2', this.value)"
                                    class="w-12 h-10 text-center font-black border-2 border-slate-200 rounded-lg focus:border-emerald-500 outline-none ml-2">
                            ` : `
                                <span class="w-10 text-center font-black text-lg ${match.s2 !== null && match.s2 > match.s1 ? 'text-emerald-600' : 'text-slate-400'}">${match.s2 ?? '-'}</span>
                            `}
                        </div>
                    </div>
                    ${match.winner ? `
                        <div class="mt-3 pt-3 border-t-2 border-emerald-200 text-center">
                            <span class="text-xs font-black text-emerald-600 uppercase">Ganador: ${getTeamName(match.winner)}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ============================================
        // HELPERS
        // ============================================
        function getTeamName(id) {
            const team = state.teams.find(t => t.id === id);
            return team ? team.name : '?';
        }

        function populateTeamFilter() {
            const select = document.getElementById('team-filter');
            select.innerHTML = '<option value="">Todos los equipos</option>' +
                state.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        function filterByTeam() {
            activeFilters.team = document.getElementById('team-filter').value;
            renderCalendar();
        }

        function filterByDay() {
            activeFilters.day = document.getElementById('day-filter').value;
            renderCalendar();
        }

        // ============================================
        // SCORE UPDATES
        // ============================================
        window.updateScore = function(day, matchIdx, field, value) {
            const matches = state.matches.filter(m => m.day === day);
            const match = matches[matchIdx];
            match[field] = value === '' ? null : parseInt(value);
            syncData();
            renderCalendar();
            updateStandings();
            renderStats();
        };

        window.updatePlayoffScore = function(type, idx, field, value) {
            let match;
            if (type === 'sf') {
                match = state.playoffs.semifinals[idx];
            } else {
                match = state.playoffs.final;
            }

            match[field] = value === '' ? null : parseInt(value);

            if (match.s1 !== null && match.s2 !== null) {
                if (match.s1 > match.s2) {
                    match.winner = match.t1;
                } else if (match.s2 > match.s1) {
                    match.winner = match.t2;
                } else {
                    if (confirm('Empate. ¬øEl ganador es ' + getTeamName(match.t1) + '? (No = ' + getTeamName(match.t2) + ')')) {
                        match.winner = match.t1;
                    } else {
                        match.winner = match.t2;
                    }
                }
                showToast('Ganador: ' + getTeamName(match.winner));

                if (type === 'sf') {
                    const sf1Winner = state.playoffs.semifinals[0].winner;
                    const sf2Winner = state.playoffs.semifinals[1].winner;
                    if (sf1Winner && sf2Winner) {
                        state.playoffs.final.t1 = sf1Winner;
                        state.playoffs.final.t2 = sf2Winner;
                    }
                }
            } else {
                match.winner = null;
            }

            syncData();
            renderPlayoffs();
        };

        // ============================================
        // STATISTICS
        // ============================================
        function renderStats() {
            const stats = updateStandings();
            
            let totalGoals = 0;
            let draws = 0;
            const completedMatches = state.matches.filter(m => m.s1 !== null && m.s2 !== null);
            
            completedMatches.forEach(m => {
                totalGoals += m.s1 + m.s2;
                if (m.s1 === m.s2) draws++;
            });

            const avgGoals = completedMatches.length > 0 ? (totalGoals / completedMatches.length).toFixed(1) : 0;

            document.getElementById('stat-total-goals').innerText = totalGoals;
            document.getElementById('stat-avg-goals').innerText = avgGoals;
            document.getElementById('stat-draws').innerText = draws;

            const topScorers = [...stats].sort((a, b) => b.gf - a.gf).slice(0, 5);
            document.getElementById('top-scorers').innerHTML = topScorers.map((t, i) => `
                <div class="flex items-center justify-between p-3 bg-emerald-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-emerald-600">${i + 1}</span>
                        <span class="font-bold text-sm text-emerald-900">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚öΩ</span>
                        <span class="text-xl font-black text-emerald-700">${t.gf}</span>
                    </div>
                </div>
            `).join('');

            const bestDefenses = [...stats].sort((a, b) => a.gc - b.gc).slice(0, 5);
            document.getElementById('best-defenses').innerHTML = bestDefenses.map((t, i) => `
                <div class="flex items-center justify-between p-3 bg-blue-50 rounded-xl">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl font-black text-blue-600">${i + 1}</span>
                        <span class="font-bold text-sm text-blue-900">${t.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">üõ°Ô∏è</span>
                        <span class="text-xl font-black text-blue-700">${t.gc}</span>
                        <span class="text-xs text-blue-500">en contra</span>
                    </div>
                </div>
            `).join('');

            const journeyStats = {};
            for (let day = 1; day <= 9; day++) {
                const dayMatches = state.matches.filter(m => m.day === day && m.s1 !== null && m.s2 !== null);
                const goals = dayMatches.reduce((sum, m) => sum + m.s1 + m.s2, 0);
                journeyStats[day] = { total: dayMatches.length, goals };
            }

            document.getElementById('journey-stats').innerHTML = Object.entries(journeyStats).map(([day, data]) => `
                <div class="flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg transition-colors">
                    <span class="font-bold text-slate-700">Jornada ${day}</span>
                    <div class="flex gap-4 text-[10px]">
                        <span class="text-slate-500">${data.total} partidos</span>
                        <span class="font-black text-emerald-600">${data.goals} goles</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // EXPORT
        // ============================================
        window.exportToExcel = function() {
            const stats = updateStandings();
            
            const standingsData = stats.map((s, i) => ({
                'Posici√≥n': i + 1,
                'Equipo': s.name,
                'PJ': s.pj,
                'V': s.v,
                'E': s.e,
                'D': s.d,
                'GF': s.gf,
                'GC': s.gc,
                'DIF': s.gf - s.gc,
                'PTS': s.pts
            }));

            const matchesData = state.matches.map(m => ({
                'Jornada': m.day,
                'Local': getTeamName(m.t1),
                'Goles Local': m.s1 ?? '-',
                'Goles Visitante': m.s2 ?? '-',
                'Visitante': getTeamName(m.t2)
            }));

            const wb = XLSX.utils.book_new();
            const wsStandings = XLSX.utils.json_to_sheet(standingsData);
            const wsMatches = XLSX.utils.json_to_sheet(matchesData);
            
            XLSX.utils.book_append_sheet(wb, wsStandings, 'Clasificaci√≥n');
            XLSX.utils.book_append_sheet(wb, wsMatches, 'Partidos');
            
            XLSX.writeFile(wb, `Campeonato_Cementerio_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('Excel exportado correctamente');
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showApp() {
            document.getElementById('step-upload').classList.add('hidden');
            document.getElementById('guest-empty').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('nav-tabs').classList.remove('hidden');
            
            renderTeams();
            renderCalendar();
            updateStandings();
            renderPlayoffs();
            renderStats();
            populateTeamFilter();
        }

        window.clearAllData = function() {
            if (confirm('¬øEst√°s seguro? Se borrar√°n TODOS los datos del torneo.')) {
                if (confirm('Esta acci√≥n no se puede deshacer. ¬øContinuar?')) {
                    if (firebaseEnabled) {
                        tournamentRef.remove().then(() => {
                            localStorage.removeItem('championshipState');
                            showToast('Datos eliminados');
                            setTimeout(() => location.reload(), 1000);
                        });
                    } else {
                        localStorage.removeItem('championshipState');
                        showToast('Datos eliminados');
                        setTimeout(() => location.reload(), 1000);
                    }
                }
            }
        };

        // ============================================
        // INITIALIZE
        // ============================================
        loadFromFirebase();
    </script>
</body>
</html>
